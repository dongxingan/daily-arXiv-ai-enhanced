# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: arXiv-daily-ai-enhanced

on:
  schedule:
    - cron: "30 16 * * *"
  workflow_dispatch:


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        uv sync
    - name: Run script
      run: |
        source .venv/bin/activate
        export OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
        export OPENAI_BASE_URL=${{ secrets.OPENAI_BASE_URL }}
        export LANGUAGE="${{ vars.LANGUAGE }}"
        export CATEGORIES="${{ vars.CATEGORIES }}"
        export MODEL_NAME="${{ vars.MODEL_NAME }}"
        bash run.sh
    - name: commit
      run: |
        git config --global user.email "${{ vars.EMAIL }}"
        git config --global user.name "${{ vars.NAME }}"
        git add .
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "No changes to commit"
          exit 0
        fi
        git commit -m "update"
    - name: Pull latest changes and push
      run: |
        # è®¾ç½®Gité…ç½®ä»¥å¤„ç†è‡ªåŠ¨åˆå¹¶
        git config pull.rebase true
        git config rebase.autoStash true
        
        # å°è¯•æ¨é€ï¼Œå¦‚æœå¤±è´¥åˆ™æ‹‰å–å¹¶é‡è¯•
        for i in {1..3}; do
          echo "Push attempt $i"
          if git push origin main; then
            echo "Push successful"
            break
          else
            echo "Push failed, pulling latest changes..."
            git pull origin main --no-edit || true
            if [ $i -eq 3 ]; then
              echo "Failed to push after 3 attempts"
              exit 1
            fi
          fi
        done
    - name: Check Email Configuration
      run: |
        if [ -z "${{ vars.NOTIFICATION_EMAIL }}" ]; then
          echo "âš ï¸ Email notification is not configured. Skipping email sending."
          echo "To enable email notifications, please set NOTIFICATION_EMAIL variable and SMTP secrets."
        else
          echo "âœ… Email notification is configured for: ${{ vars.NOTIFICATION_EMAIL }}"
        fi
    - name: Set Date Environment Variable
      if: success() && vars.NOTIFICATION_EMAIL != ''
      continue-on-error: true
      run: echo "TODAY=$(date -u '+%Y-%m-%d')" >> $GITHUB_ENV
    - name: Send Email Notification
      if: success() && vars.NOTIFICATION_EMAIL != ''
      continue-on-error: true
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port: ${{ secrets.SMTP_PORT }}
        username: ${{ secrets.SMTP_USERNAME }}
        password: ${{ secrets.SMTP_PASSWORD }}
        subject: "ğŸ“š Daily arXiv AI Enhanced - ${{ env.TODAY }}"
        to: ${{ vars.NOTIFICATION_EMAIL }}
        from: ${{ secrets.SMTP_USERNAME }}
        html_body: |
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.6; color: #333; max-width: 600px; margin: 0 auto; }
              .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; text-align: center; }
              .content { background: #f8f9fa; padding: 20px; border-radius: 0 0 10px 10px; }
              .info-card { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .quick-links { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
              .btn { background: #007bff; color: white; padding: 8px 16px; text-decoration: none; border-radius: 5px; display: inline-block; font-size: 14px; }
              .btn:hover { background: #0056b3; }
              .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0; }
              .stat-item { background: white; padding: 10px; border-radius: 5px; text-align: center; border-left: 4px solid #007bff; }
              .emoji { font-size: 1.2em; }
              .footer { background: #6c757d; color: white; padding: 15px; border-radius: 5px; margin-top: 20px; font-size: 12px; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1><span class="emoji">ğŸš€</span> arXiv AI Enhanced æ¯æ—¥æ›´æ–°</h1>
              <p style="margin: 5px 0; opacity: 0.9;">æ™ºèƒ½è®ºæ–‡æ‘˜è¦ä¸åˆ†æç³»ç»Ÿ</p>
            </div>
            
            <div class="content">
              <div class="info-card">
                <h2><span class="emoji">ğŸ‰</span> æ›´æ–°å®Œæˆé€šçŸ¥</h2>
                <p><strong>ğŸ“… æ›´æ–°æ—¥æœŸ:</strong> ${{ env.TODAY }}</p>
                <p><strong>â° å®Œæˆæ—¶é—´:</strong> ${{ github.run_started_at }}</p>
                <p><strong>ğŸ”„ è¿è¡Œç¼–å·:</strong> #${{ github.run_number }}</p>
              </div>

              <div class="info-card">
                <h3><span class="emoji">âš™ï¸</span> é…ç½®ä¿¡æ¯</h3>
                <div class="stats">
                  <div class="stat-item">
                    <div style="font-weight: bold; color: #007bff;">ç ”ç©¶é¢†åŸŸ</div>
                    <div>${{ vars.CATEGORIES }}</div>
                  </div>
                  <div class="stat-item">
                    <div style="font-weight: bold; color: #28a745;">AI æ¨¡å‹</div>
                    <div>${{ vars.MODEL_NAME }}</div>
                  </div>
                  <div class="stat-item">
                    <div style="font-weight: bold; color: #ffc107;">è¾“å‡ºè¯­è¨€</div>
                    <div>${{ vars.LANGUAGE }}</div>
                  </div>
                  <div class="stat-item">
                    <div style="font-weight: bold; color: #dc3545;">æ‰§è¡ŒçŠ¶æ€</div>
                    <div>âœ… æˆåŠŸ</div>
                  </div>
                </div>
              </div>

              <div class="info-card">
                <h3><span class="emoji">ğŸ”—</span> å¿«é€Ÿè®¿é—®</h3>
                <div class="quick-links">
                  <a href="https://github.com/${{ github.repository }}" class="btn">ğŸ“Š GitHub ä»“åº“</a>
                  <a href="https://github.com/${{ github.repository }}/blob/main/data/${{ env.TODAY }}.md" class="btn">ğŸ“„ ä»Šæ—¥è®ºæ–‡</a>
                  <a href="https://github.com/${{ github.repository }}/tree/main/data" class="btn">ğŸ“ å†å²æ•°æ®</a>
                  <a href="https://github.com/${{ github.repository }}/actions" class="btn">ğŸ”§ å·¥ä½œæµçŠ¶æ€</a>
                </div>
              </div>

              <div class="info-card">
                <h3><span class="emoji">ğŸ“ˆ</span> ç³»ç»Ÿç‰¹æ€§</h3>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <li><strong>ğŸ¤– AI å¢å¼º:</strong> ä½¿ç”¨ ${{ vars.MODEL_NAME }} è¿›è¡Œæ™ºèƒ½æ‘˜è¦å’Œåˆ†æ</li>
                  <li><strong>ğŸŒ å¤šè¯­è¨€:</strong> æ”¯æŒ ${{ vars.LANGUAGE }} è¾“å‡º</li>
                  <li><strong>â° è‡ªåŠ¨åŒ–:</strong> æ¯ä¸ªå·¥ä½œæ—¥è‡ªåŠ¨æ›´æ–°ï¼Œè·³è¿‡èŠ‚å‡æ—¥</li>
                  <li><strong>ğŸ“§ é€šçŸ¥:</strong> å®æ—¶é‚®ä»¶æé†’æ›´æ–°çŠ¶æ€</li>
                  <li><strong>ğŸ“Š åˆ†ç±»:</strong> ä¸“æ³¨ ${{ vars.CATEGORIES }} é¢†åŸŸè®ºæ–‡</li>
                </ul>
              </div>

              <div class="info-card">
                <h3><span class="emoji">ğŸ’¡</span> ä½¿ç”¨æç¤º</h3>
                <p><strong>ğŸ” å¦‚ä½•æŸ¥çœ‹è®ºæ–‡:</strong></p>
                <ol style="margin: 10px 0; padding-left: 20px;">
                  <li>ç‚¹å‡»ä¸Šæ–¹ "ä»Šæ—¥è®ºæ–‡" æŒ‰é’®æŸ¥çœ‹æœ€æ–°å†…å®¹</li>
                  <li>è®¿é—® "å†å²æ•°æ®" æµè§ˆå¾€æœŸè®ºæ–‡æ‘˜è¦</li>
                  <li>åœ¨ GitHub ä»“åº“ä¸­å¯ä»¥çœ‹åˆ°å®Œæ•´çš„é¡¹ç›®ä¿¡æ¯</li>
                </ol>
                
                <p><strong>âš™ï¸ è‡ªå®šä¹‰é…ç½®:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                  <li>ä¿®æ”¹ CATEGORIES å˜é‡è°ƒæ•´å…³æ³¨çš„ç ”ç©¶é¢†åŸŸ</li>
                  <li>æ›´æ”¹ MODEL_NAME åˆ‡æ¢ä¸åŒçš„ AI æ¨¡å‹</li>
                  <li>è®¾ç½® LANGUAGE å˜é‡æ›´æ”¹è¾“å‡ºè¯­è¨€</li>
                </ul>
              </div>

              <div class="info-card">
                <h3><span class="emoji">ğŸ“Š</span> å·¥ä½œæµä¿¡æ¯</h3>
                <p><strong>ğŸ†” è¿è¡Œ ID:</strong> ${{ github.run_id }}</p>
                <p><strong>ğŸŒ¿ åˆ†æ”¯:</strong> ${{ github.ref_name }}</p>
                <p><strong>ğŸ’» è§¦å‘è€…:</strong> ${{ github.actor }}</p>
                <p><strong>ğŸ”„ è§¦å‘æ–¹å¼:</strong> ${{ github.event_name }}</p>
                <p><strong>ğŸ–¥ï¸ è¿è¡Œç¯å¢ƒ:</strong> Ubuntu Latest</p>
              </div>
            </div>

            <div class="footer">
              <p style="text-align: center; margin: 0;">
                <strong>ğŸ¤– arXiv AI Enhanced è‡ªåŠ¨åŒ–ç³»ç»Ÿ</strong><br>
                ğŸ“§ æ­¤é‚®ä»¶ç”± GitHub Actions è‡ªåŠ¨å‘é€ | 
                â­ <a href="https://github.com/${{ github.repository }}" style="color: #ffc107;">ä¸ºé¡¹ç›®ç‚¹æ˜Ÿæ”¯æŒ</a> | 
                ğŸ› <a href="https://github.com/${{ github.repository }}/issues" style="color: #ffc107;">æŠ¥å‘Šé—®é¢˜</a>
              </p>
              <p style="text-align: center; margin: 10px 0 0 0; opacity: 0.8; font-size: 11px;">
                ç”Ÿæˆæ—¶é—´: ${{ github.run_started_at }} UTC | ä¸‹æ¬¡æ›´æ–°: æ˜æ—¥å·¥ä½œæ—¥ 16:30 UTC
              </p>
            </div>
          </body>
          </html>
